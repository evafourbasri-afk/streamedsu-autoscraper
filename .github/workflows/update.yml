name: Auto Update IPTV Playlists

on:
  schedule:
    - cron: "*/30 * * * *"   # setiap 30 menit
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: üîπ Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Python
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Install dependencies
    - name: üì¶ Install dependencies
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    # 4Ô∏è‚É£ Run playlist generator
    - name: üöÄ Run playlist generator
      run: |
        echo "üì° Running Python script..."
        python multi_playlist.py || exit 0
        echo "‚úÖ Script finished."

    # 5Ô∏è‚É£ Deploy to main/Branch folder
    - name: üì§ Deploy M3U to main/Branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        git checkout main

        # Pastikan folder Branch ada
        mkdir -p Branch

        # Hapus isi lama supaya tidak numpuk
        rm -rf Branch/*

        # Copy hasil dari folder output (jika ada)
        if [ -d "output" ]; then
          cp -r output/* Branch/ || true
        fi

        # Ambil jumlah link dari stats.txt (jika ada)
        LINKS_COUNT=$(cat stats.txt 2>/dev/null || echo "0")

        git add Branch/* stats.txt || true

        # Commit hanya jika ada perubahan
        if git diff --cached --quiet; then
          echo "‚ö†Ô∏è No changes to commit."
        else
          git commit -m "Auto update playlists $(date '+%Y-%m-%d %H:%M:%S') (links: ${LINKS_COUNT})"
          git push origin main
        fi
